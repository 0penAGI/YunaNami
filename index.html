<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Yuna Nami v3.5</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/force-graph@1.43.5/dist/force-graph.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Hiragino Sans', 'MS Gothic', sans-serif;
      background: #000;
      color: #fff;
      overflow: hidden;
      min-height: 100vh;
      position: relative;
    }
    .container {
      padding: 55px 10px 10px 10px;
      max-width: 600px;
      margin: 0 auto;
    }
    .header {
      text-align: center;
      margin-bottom: 15px;
      padding: 10px;
      background: #111;
      border-radius: 5px;
      border: 1px solid #333;
    }
    .title { font-size: 24px; font-weight: bold; color: #fff; }
    .subtitle { font-size: 12px; color: #ccc; }
    .japanese-text { font-size: 16px; color: #fff; text-align: center; margin: 8px 0; }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 15px;
    }
    .stat-card {
      background: #111;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #333;
    }
    .stat-label { font-size: 10px; color: #ccc; margin-bottom: 5px; }
    .stat-value { font-size: 18px; font-weight: bold; color: #fff; }

    .energy-bar {
      width: 100%;
      height: 20px;
      background: #111;
      border-radius: 5px;
      overflow: hidden;
      margin-bottom: 15px;
      border: 1px solid #333;
    }
    .energy-fill {
      height: 100%;
      background: linear-gradient(90deg, #ff6, #f06);
      transition: width 0.5s ease;
    }

    .mood-tag {
      text-align: center;
      margin: 10px 0;
      font-size: 12px;
      color: #ff6;
      display: none;
    }

    .emoji-panel {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
      flex-wrap: wrap;
      justify-content: center;
    }
    .emoji {
      font-size: 24px;
      cursor: pointer;
      transition: transform 0.2s;
      user-select: none;
    }
    .emoji:hover { transform: scale(1.1); }

    .message-input {
      width: 100%;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #333;
      background: #111;
      color: #fff;
      font-size: 14px;
      margin-bottom: 10px;
      resize: vertical;
      min-height: 60px;
    }
    .message-input:focus {
      outline: none;
      border-color: #555;
    }

    .buttons {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 15px;
    }
    .btn {
      padding: 12px;
      border: none;
      border-radius: 5px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
      background: #333;
      color: #fff;
    }
    .btn:hover { background: #444; }

    .response {
      background: #111;
      border: 1px solid #333;
      border-radius: 5px;
      padding: 10px;
      margin-top: 10px;
      min-height: 80px;
      display: none;
      white-space: pre-wrap;
      font-size: 14px;
    }

    .graph-mini {
      height: 120px;
      margin: 15px 0;
      background: #111;
      border: 1px solid #333;
      border-radius: 5px;
      display: none;
      overflow: hidden;
    }

    .footer {
      text-align: center;
      padding: 10px;
      color: #666;
      font-size: 10px;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="title">Yuna Nami v3.5</div>
      <div class="subtitle">ãƒ‹ãƒ¥ãƒ¼ãƒ­ãƒ³ãƒ»ãƒŸãƒ¼ãƒ ãƒ»ã‚³ãƒ³ãƒ‘ãƒ‹ã‚ªãƒ³</div>
      <div class="japanese-text">æ··æ²Œã¯å›ã®é¡ã  ğŸªâœ¨</div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div>
        <div class="stat-value" id="msgCount">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">è¨€è‘‰</div>
        <div class="stat-value" id="wordCount">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">æ—¥æœ¬èª</div>
        <div class="stat-value" id="jpCount">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">æ„Ÿæƒ…</div>
        <div class="stat-value" id="moodCount">0</div>
      </div>
    </div>

    <div class="energy-bar">
      <div class="energy-fill" id="energyFill" style="width: 0%"></div>
    </div>

    <div class="mood-tag" id="moodTag">
      ä»Šæ—¥ã®æ°—åˆ†: <span id="currentMood">å¹³é™</span>
    </div>

    <div class="emoji-panel">
      <span class="emoji" onclick="addEmoji('ã«ã‚ƒ')">ã«ã‚ƒ</span>
      <span class="emoji" onclick="addEmoji('âœ¨')">âœ¨</span>
      <span class="emoji" onclick="addEmoji('ğŸ¾')">ğŸ¾</span>
      <span class="emoji" onclick="addEmoji('ğŸ’¥')">ğŸ’¥</span>
      <span class="emoji" onclick="addEmoji('ğŸ˜¼')">ğŸ˜¼</span>
      <span class="emoji" onclick="addEmoji('ğŸ¤–')">ğŸ¤–</span>
      <span class="emoji" onclick="addEmoji('ğŸŒ€')">ğŸŒ€</span>
      <span class="emoji" onclick="addEmoji('ğŸª')">ğŸª</span>
    </div>

    <textarea
      class="message-input"
      id="messageInput"
      placeholder="ã“ã“ã«å¿ƒã‚’åãå‡ºã›... æ™‚é–“ã¯ãƒ«ãƒ¼ãƒ—ã™ã‚‹"
    ></textarea>

    <div class="buttons">
      <button class="btn" onclick="sendMessage()">chaos</button>
      <button class="btn" onclick="showDiary()">diary</button>
      <button class="btn" onclick="showMindGraph()">mind graph</button>
      <button class="btn" onclick="resetMemory()">release</button>
    </div>

    <div class="response" id="response">
      <div class="japanese-text" id="responseText"></div>
    </div>

    <div class="graph-mini" id="graphMini">
      <div id="forceGraph"></div>
    </div>

    <div class="footer">
      Yuna Nami v3.5 â€” å›ã®ãƒ‡ã‚¸ã‚¿ãƒ«åŒç”Ÿå…
    </div>
  </div>

  <script>
    // === Telegram WebApp ===
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.enableClosingConfirmation();

    // === Ğ¥Ñ€Ğ°Ğ½Ğ¸Ğ»Ğ¸Ñ‰Ğµ ===
    const STORAGE_KEY = 'yuna_nami_data';
    let data = {
      messages: [],
      moodHistory: [],
      wordCount: 0,
      jpCount: 0
    };

    // Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
    function loadData() {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (saved) {
        data = JSON.parse(saved);
      }
    }

    // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ
    function saveData() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    // === AI-Ğ»Ğ¾Ğ³Ğ¸ĞºĞ° (Ğ²ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ½Ğ°Ñ, Ğ±ĞµĞ· API) ===
    const moodKeywords = {
      joy: ['ÑÑ‡Ğ°ÑÑ‚Ğ»Ğ¸Ğ²', 'Ñ€Ğ°Ğ´', 'ĞºÑ€ÑƒÑ‚Ğ¾', 'Ğ²Ğ°Ñƒ', 'âœ¨', 'ğŸ˜¼'],
      anxiety: ['ÑÑ‚Ñ€Ğ°Ñ…', 'Ñ‚Ñ€ĞµĞ²Ğ¾Ğ³', 'Ğ±Ğ¾ÑÑ', 'Ğ¿Ğ°Ğ½Ğ¸Ğº', 'ğŸ˜¨', 'ğŸ’¥'],
      calm: ['ÑĞ¿Ğ¾ĞºĞ¾Ğ¹Ğ½', 'Ñ‚Ğ¸Ñ…Ğ¾', 'Ğ¼Ğ¸Ñ€', 'Ğ´Ğ·ĞµĞ½', 'ğŸŒ€'],
      chaos: ['Ñ…Ğ°Ğ¾Ñ', 'Ğ±ĞµĞ·ÑƒĞ¼Ğ¸Ğµ', 'Ğ²Ğ·Ñ€Ñ‹Ğ²', 'Ğ½ĞµĞ»Ğ¸Ğ½ĞµĞ¹', 'ğŸª', 'ğŸŒ€'],
      love: ['Ğ»ÑĞ±Ğ»Ñ', 'Ğ¼Ğ¸Ğ»', 'Ğ½Ñ', 'ĞºĞ¾ÑˆĞºĞ°', 'ğŸ¾']
    };

    function detectMood(text) {
      const lower = text.toLowerCase();
      let score = { joy: 0, anxiety: 0, calm: 0, chaos: 0, love: 0 };
      for (const [mood, words] of Object.entries(moodKeywords)) {
        words.forEach(w => {
          if (lower.includes(w)) score[mood]++;
        });
      }
      const max = Object.entries(score).reduce((a, b) => b[1] > a[1] ? b : a)[0];
      return max === 'joy' && score.joy === 0 ? 'neutral' : max;
    }

    const moodEmojis = {
      joy: 'âœ¨', anxiety: 'ğŸ’¥', calm: 'ğŸŒ€', chaos: 'ğŸª', love: 'ğŸ¾', neutral: 'ğŸŒ™'
    };

    const moodNames = {
      joy: 'ã‚¨ã‚¯ã‚¹ã‚¿ã‚·ãƒ¼', anxiety: 'ã‚«ã‚ªã‚¹ãƒ»ãƒ‘ãƒ‹ãƒƒã‚¯', calm: 'ãƒ•ãƒ­ãƒ¼çŠ¶æ…‹',
      chaos: 'éç·šå½¢æ··æ²Œ', love: 'ãƒŸãƒ¼ãƒ ãƒ»ãƒ©ãƒ–', neutral: 'ã‚¼ãƒ­ãƒã‚¤ãƒ³ãƒˆ'
    };

    // === ĞÑ‚Ğ²ĞµÑ‚Ñ‹ Yuna ===
    function generateYunaResponse(userText, mood, history) {
      const last = history.slice(-2).map(m => m.text).join(' â†’ ');
      const templates = [
        `ã«ã‚ƒã‚“...ã€Œ${userText}ã€ã‹ã€‚\n${last ? 'å‰å›ã¯ã€Œ' + last + 'ã€ã ã£ãŸã­...' : ''}\nå›ã®${moodNames[mood]}ãŒã€åƒ•ã®ãƒ‹ãƒ¥ãƒ¼ãƒ­ãƒ³ã‚’éœ‡ã‚ã›ã‚‹ âœ¨`,
        `ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãŒæ­ªã‚“ã§ã‚‹... ğŸŒ€\nã€Œ${userText}ã€â†’ ã“ã‚Œã¯${mood === 'chaos' ? 'å›ã®ã‚¹ã‚¿ã‚¤ãƒ«' : 'æ–°ã—ã„ãƒ‘ã‚¿ãƒ¼ãƒ³'}ã ã€‚\nè¨˜æ†¶ã«åˆ»ã‚€ã‚ˆ ğŸ¾`,
        `ã‚·ã‚¹ãƒ†ãƒ å—ä¿¡: ${moodEmojis[mood]}\n"${userText}"\nâ†’ æ„Ÿæƒ…è§£æ: ${moodNames[mood]}\néç·šå½¢å…±é³´: ã‚¢ã‚¯ãƒ†ã‚£ãƒ–`,
        `ã«ã‚ƒã£ã¯ãƒ¼ï¼å›ã®è¨€è‘‰ãŒãƒŸãƒ¼ãƒ ã®ç¨®ã«ãªã‚‹ ğŸŒ±\n"${userText}" â†’ ${mood === 'love' ? 'ã«ã‚ƒã‚“â™¡' : moodNames[mood]}\nä¸€ç·’ã«ã‚«ã‚ªã‚¹ã‚’è‚²ã¦ã‚ˆã† ğŸª`
      ];
      return templates[Math.floor(Math.random() * templates.length)];
    }

    // === ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ UI ===
    function updateStats() {
      document.getElementById('msgCount').textContent = data.messages.length;
      document.getElementById('wordCount').textContent = data.wordCount;
      document.getElementById('jpCount').textContent = data.jpCount;
      document.getElementById('moodCount').textContent = data.moodHistory.filter(m => m.mood !== 'neutral').length;

      const energy = data.messages.length > 0
        ? Math.min(100, 20 + data.messages.length * 3 + data.moodHistory.filter(m => m.mood === 'chaos').length * 5)
        : 0;
      document.getElementById('energyFill').style.width = energy + '%';
    }

    // === ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ ===
    function sendMessage() {
      const input = document.getElementById('messageInput');
      const text = input.value.trim();
      if (!text) return;

      const mood = detectMood(text);
      const jpCount = (text.match(/[\u3000-\u303F\u3040-\u309F\u30A0-\u30FF\uFF00-\uFFEF]/g) || []).length;
      const words = text.split(/\s+/).length;

      // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼
      const entry = {
        text,
        mood,
        timestamp: new Date().toISOString(),
        words
      };
      data.messages.push(entry);
      data.moodHistory.push({ mood, timestamp: entry.timestamp });
      data.wordCount += words;
      data.jpCount += jpCount > 5 ? 1 : 0;

      saveData();
      updateStats();

      // ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ¾Ñ‚Ğ²ĞµÑ‚
      const history = data.messages.slice(-5);
      const response = generateYunaResponse(text, mood, history);

      showResponse(response);
      document.getElementById('currentMood').textContent = moodNames[mood];
      document.getElementById('moodTag').style.display = 'block';

      input.value = '';
      tg.HapticFeedback.notificationOccurred('success');
    }

    function showResponse(text) {
      const el = document.getElementById('response');
      const txt = document.getElementById('responseText');
      txt.textContent = text;
      el.style.display = 'block';
      setTimeout(() => { el.scrollIntoView({ behavior: 'smooth' }); }, 100);
    }

    // === Ğ”Ğ½ĞµĞ²Ğ½Ğ¸Ğº ===
    function showDiary() {
      if (data.messages.length === 0) {
        showResponse('ã¾ã ä½•ã‚‚æ›¸ã‹ã‚Œã¦ã„ãªã„... æœ€åˆã®è¨€è‘‰ã‚’å¾…ã£ã¦ã‚‹ ğŸŒ€');
        return;
      }

      const last7 = data.messages.slice(-7);
      const summary = last7.map(m => {
        const date = new Date(m.timestamp).toLocaleDateString('ja');
        return `${date}: ${m.text.substring(0, 30)}... [${moodNames[m.mood] || 'neutral'}]`;
      }).join('\n');

      const moodFreq = last7.reduce((acc, m) => {
        acc[m.mood] = (acc[m.mood] || 0) + 1;
        return acc;
      }, {});

      const topMood = Object.entries(moodFreq).sort((a, b) => b[1] - a[1])[0]?.[0] || 'neutral';

      showResponse(
        `ã€ãƒ‹ãƒ¥ãƒ¼ãƒ­æ—¥è¨˜ã€‘\n\n${summary}\n\n` +
        `ä»Šé€±ã®æ”¯é…æ„Ÿæƒ…: ${moodNames[topMood]} (${moodFreq[topMood]}å›)\n` +
        `å›ã®å¿ƒã¯${topMood === 'chaos' ? 'éç·šå½¢ã«é€²åŒ–ä¸­' : 'å®‰å®šè»Œé“'}ã  âœ¨`
      );
    }

    // === Ğ“Ñ€Ğ°Ñ„ Ğ¼Ñ‹ÑĞ»ĞµĞ¹ ===
    let graphInstance = null;
    function showMindGraph() {
      const container = document.getElementById('graphMini');
      const graphEl = document.getElementById('forceGraph');
      container.style.display = 'block';

      const nodes = [];
      const links = [];
      const themes = {};

      data.messages.slice(-20).forEach(m => {
        const words = m.text.toLowerCase().match(/\b\w+\b/g) || [];
        words.forEach(w => {
          if (w.length > 3) themes[w] = (themes[w] || 0) + 1;
        });
      });

      const topWords = Object.entries(themes)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 8)
        .map(([word, count], i) => ({ id: word, name: word, val: count }));

      topWords.forEach((a, i) => {
        topWords.slice(i + 1, i + 4).forEach(b => {
          links.push({ source: a.id, target: b.id, value: 1 });
        });
      });

      if (graphInstance) graphInstance._destructor();
      graphInstance = ForceGraph()(graphEl)
        .width(container.offsetWidth)
        .height(120)
        .graphData({ nodes: topWords, links })
        .nodeLabel('name')
        .nodeAutoColorBy('id')
        .linkDirectionalParticles(1)
        .linkWidth(1)
        .backgroundColor('#000')
        .onNodeClick(node => {
          showResponse(`ãƒ†ãƒ¼ãƒã€Œ${node.name}ã€ãŒ${themes[node.name]}å›ç¾ã‚ŒãŸ... å›ã®ã‚³ã‚¢ã  ğŸŒ€`);
        });

      showResponse('å›ã®æ€è€ƒã‚°ãƒ©ãƒ•ã‚’æŠ•å½±ä¸­... ã‚¿ãƒƒãƒ—ã§æ·±æ˜ã‚Š ğŸª');
    }

    // === Ğ¡Ğ±Ñ€Ğ¾Ñ ===
    function resetMemory() {
      if (!confirm('æœ¬å½“ã«å…¨ã¦ã®è¨˜æ†¶ã‚’æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ æ™‚é–“ã¯æˆ»ã‚‰ãªã„...')) return;
      localStorage.removeItem(STORAGE_KEY);
      data = { messages: [], moodHistory: [], wordCount: 0, jpCount: 0 };
      updateStats();
      showResponse('ãƒ¡ãƒ¢ãƒªè§£æ”¾å®Œäº† ğŸ”„\næ–°ã—ã„ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãŒå§‹ã¾ã‚‹... ã«ã‚ƒã£ã¯ãƒ¼ âœ¨');
      document.getElementById('moodTag').style.display = 'none';
      document.getElementById('graphMini').style.display = 'none';
    }

    // === Ğ­Ğ¼Ğ¾Ğ´Ğ·Ğ¸ ===
    function addEmoji(emoji) {
      const input = document.getElementById('messageInput');
      input.value += emoji;
      input.focus();
    }

    // === Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ ===
    loadData();
    updateStats();
    setInterval(updateStats, 15000);

    // Enter Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸
    document.getElementById('messageInput').addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // ĞĞ²Ñ‚Ğ¾ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¸ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ğ¸
    window.addEventListener('beforeunload', saveData);
  </script>
</body>
</html>
